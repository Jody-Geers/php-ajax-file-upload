<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Upload an Image!</title>
	
	<link rel="stylesheet" type="text/css" media="all" href="styles.css" />
</head>
<body>
	
	<div id="app">
	
		<form id="upload" action="/modules/file-upload/" method="POST" enctype="multipart/form-data">
		
			<fieldset>
			<legend>Image File Upload</legend>
				
				<div id="upload-file-selector">
					<button type="button" onclick="selectFile();">Select Files</button>
				</div>
				
				<div class="display-none">
					<input id="upload-select-file" type="file" name="file" onchange="fileSelected( this );" />
				</div>
				
				<div class="display-none" id="upload-submit">
					<button type="submit" id="upload-submit-button">Upload Files</button>
				</div>
				
			</fieldset>
		
		</form>
	
		<div id="output">
		</div>
	
	</div>

</body>
<script>

// els
var uploadForm = $( 'upload' ),
	uploadFileSelector = $( 'upload-file-selector' ),
	uploadSelectFile = $( 'upload-select-file' ),
	uploadSubmit = $( 'upload-submit' ),
	uploadSubmitBtn = $( 'upload-submit-button' ),
	uploadUploading = $( 'upload-loading' ),
	regExpDisplayNone = new RegExp( '(\\s|^)' + 'display-none' + '(\\s|$)' )
;

/**
 * Helper to get el
 */
function $( id ) {
	
	return document.getElementById( id );
	
}

/**
 * Choose file to select
 */
function selectFile() {

	uploadSelectFile.click();
	
}

/**
 * File selection made
 * @param {el} - ctx element
 */
function fileSelected( el ) {

	// show selected file
	var file = el.value;
	var fileName = file.split( '\\' );
	
	uploadFileSelector.innerHTML += fileName[fileName.length-1];
	
	// show submit btn 
	uploadSubmit.className = uploadSubmit.className.replace( regExpDisplayNone, '' );
	
}

/**
* Overide form default submit behaviour
* @param {event} - form submit action	
*/
uploadForm.onsubmit = function( event ) {
	
	event.preventDefault();
	
	// Get the selected files from the input.
	var files = uploadSelectFile.files;
	
	// Create a new FormData object.
	var formData = new FormData();
	
	// Loop through each of the selected files. 
	// TODO: server does not currently accept multiple files.
	for ( var i = 0; i < files.length; i++ ) {
		
		var file = files[i];

		// Check the file type.
		if ( !file.type.match( 'image.*' ) ) {
			continue;
		}

		// Add the file to the request.
		formData.append( 'file', file, file.name );
		
	}
	
	// Set up the request.
	var xhr = new XMLHttpRequest();
	
	// Open the connection.
	xhr.open( uploadForm.method, uploadForm.action, true );
	
	// Set up a handler for when the request finishes.
	xhr.onload = function () {
		
		updateUiProcessEnd( xhr.response );
		
	};
	
	// Send the Data.
	xhr.send( formData );
}

/**
* Updates UI, Removed submit button, shows ajax	
* @param {string} - xhr.response
*/
function updateUiProcessEnd( res ) {
	
	$('output').innerHTML = res;
	
}

</script>
</html>
